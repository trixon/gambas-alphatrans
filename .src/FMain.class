' Gambas class file

Private Const KEY_MENUBAR As String = "menubar"
Private $sTemp As String = Temp$()
Private $sFilePath As String
Private $sFileEncoding As String
Private $sFileType As String

Public Sub _new()

End

Static Public Sub Run()

  Dim hForm As New FMain

  hForm.Show()

End

Public Sub Action_Activate(key As String) As Boolean

  Select Case key
    Case "about"
      About()

    Case "close"
      CloseFile()

    Case "menubar"
      Menubar()

    Case "open"
      OpenFile()

    Case "save"
      SaveFile()

    Case "quit"
      Me.Close

    Default
      Print "Unknown action: " & key

  End Select

End

Public Sub Form_KeyPress()

  If Key.Code = Key.Esc Then
    Me.Close()
  Endif

End

Public Sub Form_Open()

  Settings.Read(Me)
  lstFrom.List = MUtil.CharacterSets()
  lstTo.List = lstFrom.List
  UpdateAvailability(False)

End

Public Sub Form_Close()

  Settings.Write(Me)

End

Private Sub About()

  Dim hForm As New FAbout

  With hForm
    .AppAuthor = "Patrik Karlsson"
    .AppCopyright = ("Copyright Â© 2014 Patrik Karlsson")
    .AppDescription = ("iconv gui")
    .AppLogo = Picture.Load("logo.png")
  End With

  hForm.Run()

End

Private Sub CloseFile()

  txaFrom.Clear()
  txaTo.Clear()
  lstFrom.Index = 0
  lstTo.Index = 0
  UpdateAvailability(False)

End

Private Sub OpenFile()

  Dialog.Title = ("Open")

  If Dialog.OpenFile() Then
    Return
  Endif

  $sFilePath = Dialog.Path
  $sFileEncoding = MUtil.MimeEncoding($sFilePath)
  $sFileType = MUtil.MimeType($sFilePath)

  If $sFileEncoding = "BINARY" Then
    Message.Title = ("Error")
    Message.Error(Subst("&1 is a binary file.", $sFilePath))
  Else
    txaFrom.Text = File.Load($sFilePath)

    txaTo.Text = $sFileEncoding
    lstFrom.Index = lstFrom.Find($sFileEncoding)
    lstTo.Index = lstTo.Find($sFileEncoding)
    UpdateAvailability(True)
  Endif

End

Private Sub SaveFile()

  Debug

End

Private Sub Preview()

  Dim sBaseCommand As String = "iconv -c -f &1 -t &2 &3"
  Dim sCommand As String
  Dim sResult As String

  sCommand = Subst(sBaseCommand, lstFrom.Text, lstTo.Text, $sFilePath)
  Debug sCommand
  Try Shell sCommand To sResult
  txaTo.Text = sResult

End

Public Sub Preview_Click()

  Preview()

End

Public Sub Preview_Select()

  '  Preview()

End

Private Sub Menubar()

  Me.Menus.Visible = Settings[KEY_MENUBAR, False]

End

Public Sub UpdateAvailability(bOpen As Boolean)

  mnuClose.Enabled = bOpen
  mnuSave.Enabled = bOpen
  chkOmit.Enabled = bOpen
  optIgnore.Enabled = bOpen
  optNormal.Enabled = bOpen
  optTranslit.Enabled = bOpen

  If bOpen Then
    lblFile.Text = $sFilePath
    lblStatus.Text = $sFileEncoding & " " & $sFileType
  Else
    lblFile.Text = ""
    lblStatus.Text = ""
  Endif

End
